rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper: Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper: Check if user owns the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Helper: Ensure kycStatus field is not modified by client
    // kycStatus is authoritative and can only be set by Cloud Functions (Admin SDK)
    function kycStatusUnchanged() {
      return !('kycStatus' in resource.data)
        ? !request.resource.data.keys().hasAny(['kycStatus'])
        : request.resource.data.kycStatus == resource.data.kycStatus;
    }

    // Users collection - own data only
    match /users/{userId} {
      allow read: if isOwner(userId);
      // Allow create without kycStatus (new user signup)
      allow create: if isOwner(userId) && !request.resource.data.keys().hasAny(['kycStatus']);
      // Allow update but kycStatus must not be modified (server-only field)
      allow update: if isOwner(userId) && kycStatusUnchanged();
      allow delete: if isOwner(userId);

      // Transactions - read only (writes via Cloud Functions)
      match /transactions/{txId} {
        allow read: if isOwner(userId);
        allow write: if false;
      }

      // Notifications
      match /notifications/{notifId} {
        allow read, update: if isOwner(userId);
        allow create, delete: if false;
      }

      // Linked accounts — read only from client
      // Writes via Cloud Functions with verification
      match /linkedAccounts/{accountId} {
        allow read: if isOwner(userId);
        allow write: if false;
      }

      // Bank accounts — read only from client
      // Adding bank accounts requires verification via Cloud Function
      match /bankAccounts/{accountId} {
        allow read: if isOwner(userId);
        allow write: if false;
      }

      // Payment cards — read only from client
      // Card tokenization handled by Paystack, not stored directly
      match /cards/{cardId} {
        allow read: if isOwner(userId);
        allow write: if false;
      }
    }

    // Wallets - read own only, create allowed, updates via Cloud Functions
    match /wallets/{walletId} {
      allow read: if isAuthenticated() && request.auth.uid == walletId;
      // Allow create for own wallet only (signup)
      allow create: if isAuthenticated() && request.auth.uid == walletId;
      // Updates/deletes only via Cloud Functions (balance changes, etc.)
      allow update, delete: if false;
    }

    // Exchange rates - read only
    match /exchange_rates/{rateId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    // App config - read only
    match /app_config/{doc} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    // Rate limits - Cloud Functions only
    match /rate_limits/{userId} {
      allow read, write: if false;
    }

    // Audit logs - Cloud Functions only (no client access)
    match /audit_logs/{logId} {
      allow read, write: if false;
    }

    // Payments - Cloud Functions only (for idempotency tracking)
    match /payments/{paymentId} {
      allow read, write: if false;
    }

    // Idempotency keys - Cloud Functions only (prevents duplicate financial operations)
    match /idempotency_keys/{keyId} {
      allow read, write: if false;
    }

    // MoMo transactions - Cloud Functions only
    match /momo_transactions/{txId} {
      allow read, write: if false;
    }

    // Withdrawals - Cloud Functions only
    match /withdrawals/{withdrawalId} {
      allow read, write: if false;
    }

    // QR nonces - Cloud Functions only (replay protection)
    match /qr_nonces/{nonceId} {
      allow read, write: if false;
    }

    // Flagged transactions - Cloud Functions only (fraud review)
    match /flagged_transactions/{txId} {
      allow read, write: if false;
    }

    // Pending transactions - Cloud Functions only (amount cross-validation)
    match /pending_transactions/{txId} {
      allow read, write: if false;
    }
  }
}
